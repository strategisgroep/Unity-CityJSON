# Unity-CityJSON
Code consist of framework to read in CityJSON as a gaming object in unity. As for now there is only dealt with the geometries found in the CityJSONs, so the attributes etc. are not used. The framework was initially build for use in the 3Dcityplanner, but this part can be used in every Unity Project. The script consist of 3 main files (ImportNewCode, Geometry and GenerateMeshData) and a lot of helper function such as simpleJSON, Earcut and Coordinates.
## Data
There are a few example files on [the CityJSON webpage](https://www.cityjson.org/datasets/). From here the simple Geometries and some city models can be downloaded. Alternatively you can download CityJSON's from elsewhere or convert a CityGML file automatically to CityJSON with [the open-source project citygml-tools](https://github.com/citygml4j/citygml-tools).
Also the 3D BAG is an up-to-date data set containing 3D building models of the Netherlands in CityJSON. The 3D BAG is open data and can be downloaded from the [3D BAG Download site](https://3dbag.nl/en/download). It contains 3D models at multiple levels of detail, which are generated by combining two open data sets: the building data from the BAG and the height data from the AHN. The 3D BAG is updated regularly, keeping it up-to-date with the latest openly available building stock and elevation information. We use the LoD2.2. version since it is the best digital twin of the Netherlands.

![screenshot](https://user-images.githubusercontent.com/43202623/145060708-f0cd638b-9ac0-4e45-8d13-732e8cbf3dc0.jpeg?raw=true)

## How to use
The code is made to translate CityJSON version 1.1 to unity game objects and is tested in unity 2020.3.20f1 (LTS) and 221.2.1f1. When using other function some updates in the code might be necessary.
To use this part of the code you need to do the following:
1. make in unity a scene with a game object
2. add the import_new_code.cs to the game object
    1. findable under assets>Scripts>import
    2. add the file location of a CityJSON in the inspector
    3. Choose a Material, I used the DBshader
    4. Decide If you want to centre the coordinates (close to zero), with the Centred value and/or scale by setting the goodcoord value to true, to set the object in 3DCityplanner values.
3. run the program and then hit the spacebar and enjoy the CityJSON
4. If you want to reload the CityJSON you can hit the Spacebar again.

![screenshot](https://user-images.githubusercontent.com/43202623/145060656-15f666be-ab99-48fc-81a3-af35b1d2675f.PNG?raw=true)

## How does it work
Globally the codes works as following:

1. When you run, the awake in the Import New Code set the JSONString to the file text, you chose.
2. When you hit Spacebar the Generate() function is started and the following steps happen:
    1.  The JSON file is parsed
    2.  The vertices are translated form a JSON node to a Array
        1. The vertices can be centred if you chose to.
        2. the Vertices can change coordinate system if you chose to.
    3. We clean all the old info 
    4. We loop over the City Objects to count how many vertices and triangles are needed for the GameobjectMesh
        1. Each Object is send to the Geometry Count function
        2. first is decided what kind of Geometry we are dealing with
        3. On the lowest scale (surface) there is calculated how many vertices and triangles are needed
            1. to deal with Polygons with over 4 vertices and/or holes we use the GenerateMeshData function, which use Earcut as triangulation method.
            2. To not have to deal with this calculation again the result is saved in a dictionary with the Geometry ID as key.
        4. After the last object the buffer arrays for the vertices and triangles of the geometry are set to the total count.
    5. We loop over the City Objects to build the by adding the triangles and vertices to their buffer arrays
        1. Each Object is send to the Geometry build function
        2. first is decided what kind of Geometry we are dealing with
        3. On the lowest scale (surface) the triangles and vertices are added to the arrays
            1. To deal with Polygons with over 4 vertices the dictionary with the Geometry ID as key and the earcut result as Value is used.
3. The bufferarrays of the Vertices and triangles are send to the MakeGameObject function, Where the Mesh is made by:
    1. setting the material
    2. setting the vertices
    3. setting the triangles
    4. Transforming the position to the first vertices of the Game object.

![screenshot](https://user-images.githubusercontent.com/43202623/145060628-b072b63b-b2a5-4b5c-932d-993d38068dc1.PNG?raw=true)
